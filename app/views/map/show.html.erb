<!-- app/views/map/show.html.erb -->
<h1>map</h1>

<div data-controller="geolocation" data-action="geolocation#search">
  <%# <button data-action="geolocation#search">Find me</button> %>
</div>

<p>Your Latitude : <span id="lat"><%= @latitude %></span></p>
<p>Your Longitude : <span id="long"><%= @longitude %></span></p>
<p>Accuracy in 'm' : <span id="acc">0</span></p>

<div id="map" style="height: 700px; width: 100%;"></div>

<script>
  function initMap() {
    var latitude = parseFloat(document.getElementById('lat').innerHTML);
    var longitude = parseFloat(document.getElementById('long').innerHTML);

    var map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: latitude, lng: longitude },
      zoom: 15
    });

    var infoWindow = new google.maps.InfoWindow();

    var yourLocationMarker = new google.maps.Marker({
      position: { lat: latitude, lng: longitude },
      map: map,
      title: 'Your Location',
      icon: {
        url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
      }
    });

    yourLocationMarker.addListener("click", function () {
      infoWindow.setContent("Your Location");
      infoWindow.open(map, yourLocationMarker);
    });

    var artPieces = <%= @art_pieces.to_json.html_safe %>;

    artPieces.forEach(function (artPiece) {
      var marker = new google.maps.Marker({
        position: { lat: artPiece.latitude, lng: artPiece.longitude },
        map: map,
        title: artPiece.name,
        icon: {
          url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        }
      });

      // Add an event listener for art piece markers
      marker.addListener("click", function () {
        // Create a link to the art piece's show page
        var artPieceLink = '<a href="/art_pieces/' + artPiece.id + '">View Art Piece</a>';

        // Set the content of the info window with the art piece name and the link
        infoWindow.setContent("Art Piece: " + artPiece.name + '<br>' + artPieceLink);
        infoWindow.open(map, marker);
      });
    });
  }

  navigator.geolocation.getCurrentPosition(function (position) {
    document.getElementById('lat').textContent = position.coords.latitude;
    document.getElementById('long').textContent = position.coords.longitude;
    document.getElementById('acc').textContent = position.coords.accuracy;

    initMap();
  });
</script>


<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEzQSINw3YNC7yj7sxOiHcks8FKYXcwk0&callback=initMap"></script>
